\documentclass[a4paper,12pt]{article}
\usepackage[koi8-r]{inputenc}
\usepackage[russian]{babel}
\usepackage{hyperref}
\usepackage{mathtext}
\usepackage[T2A]{fontenc}
\usepackage{array}
\usepackage{tabularx}
\usepackage{longtable}
\usepackage[justification=centering,labelsep=period]{caption}
\usepackage{indentfirst}
\usepackage[pdftex]{graphicx,color}
\usepackage{textcomp}
\usepackage{gnuplot-lua-tikz}
\usepackage{tikz}
\usepackage{amssymb}
\usepackage{amsmath}
% \usepackage{fontogr}
% \usepackage{pscyr}
\usepackage[top=20mm,bottom=20mm,left=20mm,right=20mm]{geometry}



% \renewcommand{\captionlabeldelim} {.}

\makeatletter
\renewcommand\@biblabel[1]{#1.}
\makeatother

\unitlength=1mm

\usepackage{listings} %% собственно, это и есть пакет listings
% \usepackage{caption}
\DeclareCaptionFont{white}{\color{white}} %% это сделает текст заголовка белым
%% код ниже нарисует серую рамочку вокруг заголовка кода.
\DeclareCaptionFormat{listing}{\colorbox{white}{\parbox{\textwidth}{#1#2#3}}}
% \captionsetup[lstlisting]{format=listing,labelfont=black,textfont=black}
\renewcommand{\lstlistingname}{Листинг}


\begin{document}


\usetikzlibrary{arrows}

\lstset{ %
 language=Bash,                 % выбор языка для подсветки (здесь это С)
 basicstyle=\small\ttfamily, % размер и начертание шрифта для подсветки кода
 numbers=left,               % где поставить нумерацию строк (слева\справа)
 numberstyle=\tiny,           % размер шрифта для номеров строк
 stepnumber=1,                   % размер шага между двумя номерами строк
 numbersep=5pt,                % как далеко отстоят номера строк от
 % подсвечиваемого кода
 backgroundcolor=\color{white}, % цвет фона подсветки - используем
 showspaces=false,            % показывать или нет пробелы специальными
% отступами
 showstringspaces=false,      % показывать или нет пробелы в строках
 showtabs=false,             % показывать или нет табуляцию в строках
 frame=single,              % рисовать рамку вокруг кода
 tabsize=2,                 % размер табуляции по умолчанию равен 2 пробелам
 captionpos=t,              % позиция заголовка вверху [t] или внизу [b] 
 breaklines=true,           % автоматически переносить строки (да\нет)
% wordwrap=true,
 breakatwhitespace=false, % переносить строки только если есть пробел
 escapeinside={\%*}{*)}   % если нужно добавить комментарии в коде
 }



\author{Кузнецов В.В., ассистент кафедры ЭИУ1-КФ}
\title{Семинар \No 4 по курсу <<Основы цифровой обработки сигналов>> \\
Синтез цифрового фильтра}
\maketitle
 
\section{Цель работы} 
 
Целью семинара является синтез цифрового фильтра с конечной импульсной
характеристикой (КИХ) в среде численных расчётов
GNU/Octave. 

\section{Теоретические сведения о КИХ ЦФ}

Физически осуществимые цифровые фильтры (ЦФ), работающие в реальном масштабе
времени для формирования выходного сигнала в $i$-й дискретный момент времени
могут использовать следующие данные: 

1. Значения выходного входного сигнала в момент i-го отсчёта, а также некоторое
число прошлых входных отсчётов $x(i-1),x(i-2),\ldots,x(i-m)$;

2. Некоторое число предшествующих отсчётов выходного сигнала
$y(i-1),y(i-2),\ldots,y(i-n)$. 

Целые числа $m$ и $n$ определяют порядок ЦФ. Классификация ЦФ производится
по-разному в зависимости от того как используется информация о прошлом
состоянии системы.

Рассмотрим \emph{Трансверсальные ЦФ}. Так принято называть фильтры, которые
работают в соответствии с алгоритмом:
\begin{equation}
 y(i)=a_0x(i)+a_1x(i-1)+a_2x(i-2)+\ldots+a_mx(i-m) \label{transw-algo}
\end{equation}

Где $a_0,a_1,\ldots,a_m$ --- последовательность коэффициентов.

Число $m$ называется порядком трансверсального ЦФ. Как видно из выражения
(\ref{transw-algo}) трансверсальный фильтр производит взвешенное суммирование
предшествующих отсчётов входного сигнала и не использует прошлые отсчёты
выходного сигнала. Применив $z$-преобразование к обеим частям выражения
(\ref{transw-algo}) получим:
\begin{equation}
 Y(z)=(a_0+a_1z^{-1}+a_2z^{-2}+\ldots+a_mz^{-m})X(z)
\end{equation}

Отсюда следует, что системная функция равна:
\begin{equation}
 H(z)=\frac{Y(z)}{H(z)}=a_0+a_1z^{-1}+\ldots+a_mz^{-m}=\frac{a_0z^m+a_1z^{m-1}
+\ldots+a_m}{z^m} \label{Hz-transw}
\end{equation}

Системная функция $H(z)$ является дробно-рациональной функцией имеющей $m$
нулей и полюс при $z=0$.

Алгоритм функционирования трансверсального ЦФ поясняется структурной схемой
рис. \ref{transw-sch}.

\begin{figure}[!ht]
\begin{center}
\begin{tikzpicture}
\draw (-10mm,0) node [anchor=south] {$x_k$}-- (0,0);

\node (s) at (40mm,-30mm)  [circle,draw, inner sep=2mm] {$\Sigma$};

\foreach \x / \a in {0mm/$a_0$,20mm/$a_1$,40mm/$a_2$,60mm/$a_3$}
{
\fill (\x,0) circle (0.7mm);
\draw [-latex] (\x,0)--(\x+5mm,0);
\draw (\x+5mm, -5mm)rectangle (\x+15mm,5mm);
\draw (\x+5mm,0) node [anchor=west] {$z^{-1}$};
\draw [-latex] (\x,0) -- (\x,-10mm);
\draw (\x-5mm,-10mm) node [anchor=north east] {\a} -- (\x+5mm,-10mm) --
(\x,-20mm) -- (\x-5mm,-10mm);
\draw  (\x+15mm,0)--(\x+20mm,0);
\draw [-latex] (\x,-20mm) -- (s);
}
\draw [-latex] (80mm,0) -- (80mm,-10mm);
\draw (75mm,-10mm) node [anchor=north east] {$a_m$} -- (85mm,-10mm) --
(80mm,-20mm) -- (75mm,-10mm);
\draw [-latex] (80mm,-20mm) -- (s);
\draw [-latex] (s)--(40mm,-40mm)--(50mm,-40mm) node [anchor=west] {$y_k$};
\end{tikzpicture} 
\end{center}
\caption{Схема построения трансверсального ЦФ}\label{transw-sch}
\end{figure}

Основными элементами фильтра служат блоки задержки отсчётных значений на один
интервал дискретизации $z^{-1}$ и масштабные блоки, выполняющие в цифровой
форме операции умножения на соответствующие коэффициенты. С выходов масштабных
блоков сигнал поступает в сумматор $\Sigma$, где складываясь образуют отсчёты
выходного сигнала. Вид представленной схемы поясняетет смысл термина
трансверсальный фильтр (англ. transverse --- поперечный). Данная структурная
схема не является электрической схемой, а служит графическим изображением
алгоритма обработки сигнала на ЭВМ. Входными и выходными данными для такого
алгоритма служат массивы чисел.

Из обратного Z-преобразования выражения (\ref{Hz-transw}) следует, что
импульсная характеристика определяется коэффициентами $a_n$ и равна:

\begin{equation}
 h(k)=Z^{-1}[H(z)]=(a_0,a_1,a_2,\ldots,a_m)
\end{equation}

Данная последовательность отсчётов будет реакцией фильтра на единичный импульс
$(1,0,0,\ldots)$ на входе. Импульсная характеристика трансверсального фильтра
содержит конечное число членов и данный фильтр всегда устойчив.

Частотная характеристика фильтра получается подстановкой в выражение
(\ref{Hz-transw}) $z=e^{j\omega T}$. При этом получим частотный коэффициент
передачи:

\begin{equation}
 K(j\omega)=a_0+a_1 e^{-j\omega T}+a_2 e^{-j2\omega T}+\ldots+a_m e^{-jm\omega
T}
\end{equation}

Подбирая коэффициенты $a_m$ в данном выражении можно получать различные виды АЧХ
фильтра (фильтр Чебышева, Баттерворта, ФНЧ, ФВЧ).

Пример программной реализации цифровой фильтрации на основе данного алгоритма
на языке С приведён в листинге \ref{KIX-filt-C}.

\lstset{language=C}
\begin{lstlisting}[caption=Код на языке С для реализации цифрового
фильтра.,label=KIX-filt-C]
float Filter(float xn)
{
nm1=N-1;
yn=0;
for (k=0;k,nm1;++k) {     //смещение данных чтобы
   x[nm1-k]=x[nm1-k-1];   // обсвободить место для новой выборки
   x[0]=xn;
} 
for (k=0;k,N;++k) {
   yn=yn+h[k]*x[k];       //данные фильтруются и формируется
}                         //новая выборка
return yn;                // возвращается выходная выборка фильтра
}
\end{lstlisting}



В данном пример коэффициенты фильтра хранятся в массиве \verb|h[N]| из N
элементов. В массиве $x[N]$ хранятся предыдущие отсчёты входных данных. Функция
возвращает выходную выборку фильтра.

\section{Пример синтеза КИХ ЦФ}

Рассмотрим пример синтеза цифрового фильтра в системе GNU/Octave. 

Функции синтеза цифровых фильтров находятся в пакете \verb|signal|. Функция
\verb|fir1(n,w)| возвращает массив коэффициентов цифрового ФНЧ по заданному
порядку ЦФ \verb|n| и нормированной частоте среза \verb|w| (отношение частоты
среза и частоты дискретизации). 

Функция \verb|filter(b,a,s)| применяет фильтр с коэффициентами \verb|b|
рекурсивной части и коэффициентами \verb|a| рекурсивной части к сигналу,
представляемому массивом \verb|s|.

Функция \verb|freqz(b,a)| строит график АЧХ ЦФ с коэффициентами рекурсивной
части \verb|a| и коэффициентами нерекурсивной части \verb|b|. 

Ниже приведён пример синтеза ЦФ в системе GNU/Octave. Синтезируем КИХ 32-го и
128-го порядка с частотой среза, равной 500 Гц. Частота дискретизации 8000 Гц. 

\begin{verbatim}
pkg load signal; # загружаем пакет обработки сигналов
f=500; # частота среза ЦФ, Гц
fs=8000; # частота дискретизации ЦФ, Гц
b=fir1(32,f/fs); # рассчитываем коэффициенты ЦФ 32-го порядка
freqz(b); # строим АЧХ
b1=fir1(128,f/fs); # КИХ 
freqz(b1);
t=0:(1/fs):1.0; # время
s=sin(2*pi*100*t)+sin(2*pi*1000*t); # сигнал, который подлежит фильтрации
sf=filter(b,1,s); # фильтрованный сигнал
subplot(2,1,1); # графики
plot(t,s);
axis([0,0.1]);
subplot(2,1,2);
plot(t,sf);
axis([0,0.1]);
\end{verbatim}

АЧХ синтезированных цифровых фильтров показаны на рис. \ref{fir64-octave}
\ref{fir128-octave}. Из графиков видно, что прямоугольность АЧХ у фильтра
128-го порядка выше, чем у фильтра 32-го порядка.

Результат применения цифрового ФНЧ к сумме двух
синусоидальных сигналов частотой 100 Гц и 1000 Гц показан на
рис.\ref{fir-result}. Видно, что после прохождения через фильтр сигнал с
частотой 1000 Гц подавляется.

\begin{figure}[!ht]
\begin{center}
\input{fir32.tex}
\end{center}
\caption{АЧХ и ФЧХ КИХ цифрового фильтра 32-го порядка} \label{fir64-octave}
\end{figure}

\begin{figure}[!ht]
\begin{center}
\input{fir128.tex}
\end{center}
\caption{АЧХ и ФЧХ КИХ цифрового фильтра 128-го порядка} \label{fir128-octave}
\end{figure}

\begin{figure}[!ht]
\begin{center}
\input{fir-result.tex} 
\end{center}
\caption{Результат применения ЦФ к сумме двух синусоидальных сигналов. Верхняя
кривая --- сигнал на входе фильтра; нижняя кривая --- сигнал на выходе фильтра.}
\label{fir-result}
\end{figure}

% \pagebreak

\section{Задание для самостоятельной работы}

Используя скрипт из раздела 3 синтезировать КИХ цифровой фильтр 32-го порядка с
частотой среза согласно вариантам. Частота среза вычисляется по формулам:

Для группы РПД-91:
\begin{equation}
 f_2=30N + 60,\qquad Гц
\end{equation}

Для группы РПД\_С-91:
\begin{equation}
 f_2=32N + 100,\qquad Гц
\end{equation}

Подобрать частоту двухтонального сигнала для демонстрации работы фильтра.
Построить графики АЧХ, ФЧХ фильтра, исходного и фильтрованного сигнала. Как
изменяется АЧХ с увеличением порядка фильтра?

\end{document}
